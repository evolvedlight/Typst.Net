name: pack

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  pack:
    runs-on: ubuntu-latest
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      RUST_VERSION: 1.91.1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x
          cache: true

      - name: Install build prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            libssl-dev \
            llvm \
            clang \
            zlib1g-dev \
            mingw-w64 \
            ca-certificates
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Rust toolchain
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain "$RUST_VERSION"
        shell: bash

      - name: Add cargo to PATH
        run: echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Add Rust cross-compilation targets
        run: |
          rustup target add x86_64-pc-windows-gnu x86_64-unknown-linux-gnu

      - name: Restore .NET solution
        run: dotnet restore Typst.Net.sln

      - name: Pack Typst.Net
        run: dotnet pack src/Typst.Net/Typst.Net.csproj -c Release -o artifacts

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v4
        with:
          name: typst-net-nuget
          path: artifacts
